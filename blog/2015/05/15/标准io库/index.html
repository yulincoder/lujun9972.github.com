<!DOCTYPE html>
<html lang="en">
<head>
  <title>标准IO库 - 暗无天日</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <meta name="author" content="DarkSun" />
  <style>
   #ds-thread #ds-reset .ds-comment-body p {color: #ffffff;}
   #ds-thread #ds-reset .ds-comment-body p a {color: #ff0;}
   #ds-thread #ds-reset .ds-comment-body p a:hover {color: #0ff;}
   #disqus_thread a {color: #00ffff;}
  </style>
  <link rel="stylesheet" href="https://lujun9972.github.io/media/css/main.css" type="text/css"/>
  <link rel="stylesheet" href="https://lujun9972.github.io/media/css/comment.css" type="text/css"/>
</head>

  <body><div class="container">
<div>
  <header class="masthead">
    <h1 class="masthead-title"><a href="https://lujun9972.github.io/">暗无天日</a></h1>
    <p>=============&gt;随便,谢谢</p>
    <nav class="site-nav">
      <div class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z" fill="#ffff00"/>
          <path d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z" fill="#ffff00"/>
          <path d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z" fill="#ffff00"/>
        </svg>
      </div>
      <ul class="trigger">
        <li><a href="https://lujun9972.github.io/years/">Years</a></li>
        <li><a href="https://lujun9972.github.io/authors/">Authors</a></li>
        <li><a href="https://lujun9972.github.io/tags/">Tags</a></li>
        <li><a href="https://lujun9972.github.io/about/">About</a></li>
        <li><a href="https://github.com/lujun9972/lujun9972.github.com">Github</a></li>
        <li><a href="https://lujun9972.github.io/rss.xml">RSS</a></li>
      </ul>
    </nav>
    <form method="get" id="searchform" action="http://www.google.com/search">
      <input type="text" class="field" name="q" id="s" placeholder="Search">
      <input type="hidden" name="as_sitesearch" value="lujun9972.github.io">
    </form>
  </header>
</div>

<div>
<div class="post">
<h1 class="title">标准IO库</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org723058c">1. 流与FILE对象</a>
<ul>
<li><a href="#org657a76a">1.1. 流定向</a>
<ul>
<li><a href="#org662b98d">1.1.1. fwide函数:设置流的定向</a></li>
<li><a href="#orgb148a6a">1.1.2. freopen函数:清除一个流的定向</a></li>
</ul>
</li>
<li><a href="#org7fd1e8b">1.2. 打开流</a></li>
<li><a href="#org9daa1e4">1.3. 读写流</a>
<ul>
<li><a href="#orgc0ed9bb">1.3.1. 一次一个字符的IO</a></li>
<li><a href="#org411a7ef">1.3.2. 一次一行的IO</a></li>
<li><a href="#orgc74ac19">1.3.3. 二进制直接IO</a></li>
</ul>
</li>
<li><a href="#org8db5ff9">1.4. 定位流</a></li>
<li><a href="#org3530d10">1.5. 错误判断</a></li>
<li><a href="#org2511f0f">1.6. fileno:获取流对应的文件描述符</a></li>
</ul>
</li>
<li><a href="#org190ff1e">2. 缓冲</a>
<ul>
<li><a href="#orgbc88c32">2.1. 全缓冲</a></li>
<li><a href="#orgc44f934">2.2. 行缓冲</a></li>
<li><a href="#org462c0af">2.3. 缓冲的惯例</a></li>
<li><a href="#orga0961c3">2.4. 更改缓冲类型</a>
<ul>
<li><a href="#org5bdb8da">2.4.1. setbuf函数:打开/关闭缓冲机制</a></li>
<li><a href="#orgd1b1324">2.4.2. setvbuf函数:精确指定缓冲类型</a></li>
<li><a href="#orge49585d">2.4.3. fflush函数:强制将缓冲区内容写入磁盘</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org44a6208">3. 标准输入,标准输出和标准出错</a></li>
<li><a href="#orgc930801">4. 产生临时文件</a></li>
<li><a href="#orgc4810bd">5. 线程安全的方式管理FILE对象</a></li>
</ul>
</div>
</div>

<div id="outline-container-org723058c" class="outline-2">
<h2 id="org723058c"><span class="section-number-2">1</span> 流与FILE对象</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org657a76a" class="outline-3">
<h3 id="org657a76a"><span class="section-number-3">1.1</span> 流定向</h3>
<div class="outline-text-3" id="text-1-1">
<p>
标准IO文件流可用于单字符或多字符字符集. 流的定向(orientation)决定了所读,写的字符是单字符还是多字符的.
</p>

<p>
当一个流被最初创建时,它并没有定向. 
</p>

<p>
如果在未定向的流上使用一个多字节IO函数(&lt;wchar.h&gt;),则将该流的定向设置为宽定向的.
</p>

<p>
如果在未定向的流上使用一个单字节IO函数,则流的定向设置为单字节定向.
</p>
</div>

<div id="outline-container-org662b98d" class="outline-4">
<h4 id="org662b98d"><span class="section-number-4">1.1.1</span> fwide函数:设置流的定向</h4>
<div class="outline-text-4" id="text-1-1-1">
<div class="org-src-container">
<pre class="src src-C"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">wchar.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">&#33509;mode&#21442;&#25968;&#20540;&#20026;&#36127;,fwide&#23581;&#35797;&#23558;&#27969;&#35774;&#32622;&#20026;&#21333;&#23383;&#33410;&#23450;&#21521; </span><span style="color: #2aa1ae; background-color: #292e34;">*/</span>
<span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">&#33509;mode&#21442;&#25968;&#20540;&#20026;&#27491;,fwide&#23581;&#35797;&#23558;&#27969;&#35774;&#32622;&#20026;&#22810;&#23383;&#33410;&#23450;&#21521; </span><span style="color: #2aa1ae; background-color: #292e34;">*/</span>
<span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">&#33509;mode&#21442;&#25968;&#20540;&#20026;0,fwide&#19981;&#35774;&#32622;&#23450;&#21521;,&#21482;&#26159;&#36820;&#22238;&#35813;&#27969;&#30340;&#23450;&#21521; </span><span style="color: #2aa1ae; background-color: #292e34;">*/</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">fwide</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #7590db;">fp</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">mode</span><span style="color: #4f97d7;">)</span>;  <span style="color: #2aa1ae; background-color: #292e34;">/*  </span><span style="color: #2aa1ae; background-color: #292e34;">&#36820;&#22238;&#20540;&#34920;&#31034;&#27969;&#30340;&#23450;&#21521;,&#27491;&#20026;&#23485;&#23450;&#21521;,&#36127;&#20026;&#20294;&#23450;&#21521;,0&#20026;&#26410;&#23450;&#21521;</span><span style="color: #2aa1ae; background-color: #292e34;">*/</span>
</pre>
</div>

<p>
注意:
</p>
<ul class="org-ul">
<li>fwide并不改变已定向流的定向</li>
<li>fwide无出错返回. 只能根据errno的值来判断流是否无效</li>
</ul>
</div>
</div>

<div id="outline-container-orgb148a6a" class="outline-4">
<h4 id="orgb148a6a"><span class="section-number-4">1.1.2</span> freopen函数:清除一个流的定向</h4>
</div>
</div>

<div id="outline-container-org7fd1e8b" class="outline-3">
<h3 id="org7fd1e8b"><span class="section-number-3">1.2</span> 打开流</h3>
<div class="outline-text-3" id="text-1-2">
<div class="org-src-container">
<pre class="src src-C"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #bc6ec5; font-weight: bold;">fopen</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">path</span>,<span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">type</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #bc6ec5; font-weight: bold;">freopen</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">path</span>,<span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">type</span>,<span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #bc6ec5; font-weight: bold;">fdopen</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">filedes</span>,<span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">type</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>

<ul class="org-ul">
<li>fopen打开一个指定的文件,返回新的流</li>

<li><p>
freopen在一个指定的流上打开一个指定的文件. 
</p>

<p>
若该流已被打开,则关闭该流.
</p>

<p>
若该流以及定向,则清除该定向
</p>

<p>
该函数一般将一个指定的文件打开为一个预定义的流:stdin,stdout,stderr
</p></li>

<li><p>
fdopen将一个标准IO流与文件描述符相结合.
</p>

<p>
该函数一般用于将PIPE/SOCKET返回的描述符与标准IO流结合,因为这些特殊类型的文件不能用fopen函数打开.
</p></li>

<li>当以读写类型打开文件时,具有如下限制:
<ul class="org-ul">
<li>如果中间没有fflush,fseek,fsetops或rewind,则输出的后面不能直接跟随输入</li>

<li>如果中间没有fseek,fsetpos或rewind或一个输入操作没有到达文件尾部,则再输入操作之后不能直接跟随输出.</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org9daa1e4" class="outline-3">
<h3 id="org9daa1e4"><span class="section-number-3">1.3</span> 读写流</h3>
<div class="outline-text-3" id="text-1-3">
</div>
<div id="outline-container-orgc0ed9bb" class="outline-4">
<h4 id="orgc0ed9bb"><span class="section-number-4">1.3.1</span> 一次一个字符的IO</h4>
<div class="outline-text-4" id="text-1-3-1">
<div class="org-src-container">
<pre class="src src-C"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">getc</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">fgetc</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">getchar</span><span style="color: #4f97d7;">()</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">ungetc</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">c</span>,<span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">putc</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">c</span>,<span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">fputc</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">c</span>,<span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">putchar</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">c</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
<p>
其中getc和fgetc的区别为,getc可能为宏,而fgetc一定是函数. 即
</p>
<ul class="org-ul">
<li>getc的参数不应当是具有副作用的表达式</li>
<li>fgetc一定可以得到其地址,从而作为参数传递给另一个参数.</li>
<li>fgetc调用时间可能会长于getc,因为调用函数所需的时间通常长于调用宏.</li>
<li>ungetc压回的字符, <b>可以不是刚读出的字符</b></li>
</ul>

<p>
putc和fputc的区别类似于getc和fgetc的区别.
</p>
</div>
</div>
<div id="outline-container-org411a7ef" class="outline-4">
<h4 id="org411a7ef"><span class="section-number-4">1.3.2</span> 一次一行的IO</h4>
<div class="outline-text-4" id="text-1-3-2">
<div class="org-src-container">
<pre class="src src-C"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #bc6ec5; font-weight: bold;">fgets</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">buf</span>,<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">n</span>,<span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #bc6ec5; font-weight: bold;">gets</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">buf</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">fputs</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">str</span>,<span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">puts</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">str</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
<p>
注意:
</p>
<ul class="org-ul">
<li>gets不能指定缓冲区的长度, <b>且gets并不将换行符存入缓冲区内</b>.</li>
<li>fgets读取时会保持换行符</li>
<li>fputs输出时,指数出str的内容,而不会添加换行符</li>
<li><b>puts输出时,会添加换行符</b>.</li>
</ul>
</div>
</div>
<div id="outline-container-orgc74ac19" class="outline-4">
<h4 id="orgc74ac19"><span class="section-number-4">1.3.3</span> 二进制直接IO</h4>
<div class="outline-text-4" id="text-1-3-3">
<div class="org-src-container">
<pre class="src src-C"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #bc6ec5; font-weight: bold;">fread</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span>* <span style="color: #7590db;">ptr</span>,<span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">size</span>,<span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">ntimes</span>,<span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #bc6ec5; font-weight: bold;">fwrite</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">void</span>* <span style="color: #7590db;">ptr</span>,<span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">size</span>,<span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">ntimes</span>,<span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
<ul class="org-ul">
<li>这两个函数,常用于从二进制文件中读/写一个结构</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org8db5ff9" class="outline-3">
<h3 id="org8db5ff9"><span class="section-number-3">1.4</span> 定位流</h3>
<div class="outline-text-3" id="text-1-4">
<div class="org-src-container">
<pre class="src src-C"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #bc6ec5; font-weight: bold;">ftell</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">fseek</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #7590db;">fp</span>,<span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">offset</span>,<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">whence</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">rewind</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">off_t</span> <span style="color: #bc6ec5; font-weight: bold;">ftello</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">fseeko</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #7590db;">fp</span>,<span style="color: #ce537a; font-weight: bold;">off_t</span> <span style="color: #7590db;">offset</span>,<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">whence</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">fgetpos</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #7590db;">fp</span>,<span style="color: #ce537a; font-weight: bold;">fpos_t</span>* <span style="color: #7590db;">pos</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">fsetpos</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #7590db;">fp</span>,<span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">fpos_t</span>* <span style="color: #7590db;">pos</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org3530d10" class="outline-3">
<h3 id="org3530d10"><span class="section-number-3">1.5</span> 错误判断</h3>
<div class="outline-text-3" id="text-1-5">
<p>
读取出错或到达文件结尾,读取函数的返回值都是同一个值. 为了区分这两种不同的情况,必须调用ferror或feof
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">ferror</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">feof</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">clearerr</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org2511f0f" class="outline-3">
<h3 id="org2511f0f"><span class="section-number-3">1.6</span> fileno:获取流对应的文件描述符</h3>
<div class="outline-text-3" id="text-1-6">
<div class="org-src-container">
<pre class="src src-C"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">fileno</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org190ff1e" class="outline-2">
<h2 id="org190ff1e"><span class="section-number-2">2</span> 缓冲</h2>
<div class="outline-text-2" id="text-2">
<p>
标准IO提供了2种类型的缓冲
</p>
</div>

<div id="outline-container-orgbc88c32" class="outline-3">
<h3 id="orgbc88c32"><span class="section-number-3">2.1</span> 全缓冲</h3>
<div class="outline-text-3" id="text-2-1">
<p>
填满IO缓冲区才进行实际的IO操作
</p>

<p>
对于驻留在磁盘上的文件,通常是由标准IO库实施全缓冲.
</p>
</div>
</div>

<div id="outline-container-orgc44f934" class="outline-3">
<h3 id="orgc44f934"><span class="section-number-3">2.2</span> 行缓冲</h3>
<div class="outline-text-3" id="text-2-2">
<p>
当输入和输出中遇到换行符时,标准IO库执行IO操作
</p>

<p>
当流涉及一个终端时,通常使用行缓冲.
</p>
</div>
</div>

<div id="outline-container-org462c0af" class="outline-3">
<h3 id="org462c0af"><span class="section-number-3">2.3</span> 缓冲的惯例</h3>
<div class="outline-text-3" id="text-2-3">
<p>
一般标准IO缓冲的惯例为:标准出错不带缓冲,打开至终端设备的流是行缓冲,其他流是全缓冲.
</p>
</div>
</div>

<div id="outline-container-orga0961c3" class="outline-3">
<h3 id="orga0961c3"><span class="section-number-3">2.4</span> 更改缓冲类型</h3>
<div class="outline-text-3" id="text-2-4">
<div class="org-src-container">
<pre class="src src-C"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">setbuf</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #7590db;">fp</span>,<span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">buf</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">setvbuf</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #7590db;">fp</span>,<span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">buf</span>,<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">mode</span>,<span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">size</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
</div>

<div id="outline-container-org5bdb8da" class="outline-4">
<h4 id="org5bdb8da"><span class="section-number-4">2.4.1</span> setbuf函数:打开/关闭缓冲机制</h4>
<div class="outline-text-4" id="text-2-4-1">
<p>
当为打开缓冲机制时,这里参数buf必须为一个长度为BUFSIZ的缓冲区(BUFSIZ定义在stdio.h中)
</p>

<p>
若要关闭缓冲机制,参数buf为NULL
</p>
</div>
</div>

<div id="outline-container-orgd1b1324" class="outline-4">
<h4 id="orgd1b1324"><span class="section-number-4">2.4.2</span> setvbuf函数:精确指定缓冲类型</h4>
<div class="outline-text-4" id="text-2-4-2">
<ul class="org-ul">
<li><p>
参数mode可以为:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">_IOFBF</td>
<td class="org-left">全缓冲</td>
</tr>

<tr>
<td class="org-left">_IOLBF</td>
<td class="org-left">行缓冲</td>
</tr>

<tr>
<td class="org-left">_IONBF</td>
<td class="org-left">无缓冲</td>
</tr>
</tbody>
</table></li>

<li><p>
参数buf无长度限制,因为有参数size指定缓冲大小.
</p>

<p>
<b>若流设置为带缓冲的,而buf为NULL,则表示IO自动为该流分配适当长度的缓冲区(一般为BUFSIZ大小)</b>
</p>

<p>
一般而言,应由系统选择缓冲区的长度,并自动分配缓冲区.
</p></li>
</ul>
</div>
</div>

<div id="outline-container-orge49585d" class="outline-4">
<h4 id="orge49585d"><span class="section-number-4">2.4.3</span> fflush函数:强制将缓冲区内容写入磁盘</h4>
<div class="outline-text-4" id="text-2-4-3">
<div class="org-src-container">
<pre class="src src-C"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">fflush</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-org44a6208" class="outline-2">
<h2 id="org44a6208"><span class="section-number-2">3</span> 标准输入,标准输出和标准出错</h2>
<div class="outline-text-2" id="text-3">
<p>
&lt;stdio.h&gt;中预定义了三个文件指针:stdin,stdout和stderr
一般来说,stderr不带缓冲,stdin和stdout为行缓冲
</p>
</div>
</div>
<div id="outline-container-orgc930801" class="outline-2">
<h2 id="orgc930801"><span class="section-number-2">4</span> 产生临时文件</h2>
<div class="outline-text-2" id="text-4">
<div class="org-src-container">
<pre class="src src-C"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #bc6ec5; font-weight: bold;">tmpnam</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">ptr</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #bc6ec5; font-weight: bold;">tempnam</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">directory</span>,<span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">prefix</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #bc6ec5; font-weight: bold;">tmpfile</span><span style="color: #4f97d7;">()</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">mkstemp</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">template</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
<ul class="org-ul">
<li>tmpnam函数产生一个临时文件的名字字符串,最多能调用TMP_MAX次</li>

<li>参数ptr可以为NULL,则产生的路径名存放在一个静态区域,下一次调用时被覆盖.</li>

<li>若ptr不为NULL,则数组长度应该不少于L_tmpnam</li>

<li>tmpfile创建一个临时的二进制文件. 关闭该文件或程序结束后会 <b>自动删除该文件</b>.</li>

<li>tempnam与tmpnam的不同在于它允许调用者为所产生的临时文件路径指定目录和前缀. 其按如下顺序选择目录
<ol class="org-ol">
<li><b>环境变量TMPDIR</b> (此时忽略参数directory的值!)</li>

<li>参数directory</li>

<li>&lt;stdio.h&gt;中的字符串P_tmpdir(通常为/tmp)</li>

<li>本地目录</li>
</ol></li>

<li>tempnam中的prefix参数最多只能包含5个字符.</li>

<li>mkstemp的参数template必须为一个路径名,且 <b>最后6个字符设置为XXXXXX</b></li>

<li>mkstemp产生的 <b>临时文件不会自动被删除</b></li>
</ul>
</div>
</div>

<div id="outline-container-orgc4810bd" class="outline-2">
<h2 id="orgc4810bd"><span class="section-number-2">5</span> 线程安全的方式管理FILE对象</h2>
<div class="outline-text-2" id="text-5">
<p>
PSOXI.1提供了以线程安全的方式管理FILE文件的方法. 可以使用`flockfile'和`ftrylockfile'获取与FILE对象关联的锁,且这个锁为递归锁.
</p>

<p>
所有操作FILE对象的标准IO函数,都需要表现的好像内部调用了flockfile和funlockfile一样,即不能出现多个线程同时写入同一FILE对象时出现乱序的情况.
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">ftrylockfile</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">flockfile</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">funlockfile</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
<p>
通过这些函数,我们可以把多个标准IO函数的调用组合成一个原子序列.
</p>

<p>
若标准IO函数每次操作都获取自己的锁再释放,那么在进行单字符的IO操作时,会消耗大量的性能到加解锁中,因此就有了 <b>不加锁的基于字符的标准IO函数</b>
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">getchar_unlocked</span><span style="color: #4f97d7;">()</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">getc_unlocked</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">putchar_unlocked</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">c</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">putc_unlocked</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">c</span>,<span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
<p>
<b>请保证这四个函数调用时包含在flockfile/ftrylockfile和funlockfile中</b>
</p>
</div>
</div>

</div>
</div>
<div>
        <div class="post-meta">
            <span title="post date" class="post-info">2015-05-15</span>
            <span title="last modification date" class="post-info">2016-10-24</span>
            <span title="tags" class="post-info">:N/A:</span>
            <span title="author" class="post-info"><a href="mailto:lujun9972 &lt;at&gt; F31">DarkSun</a></span>
        </div>
    <script src="https://lujun9972.github.io/media/js/jquery-2.1.3.min.js"></script>
        <section>
            <h1>Comments</h1>
            <div id="comment-wrap">
                    <a class="disqus_label">使用 Disqus 评论</a>
    </ul>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
         //var disqus_developer = 1;
         var preempt_signal=false;
         var disqus_identifier = "/blog/2015/05/15/标准io库/";
         var disqus_url = "https://lujun9972.github.io/blog/2015/05/15/标准io库/";
         var disqus_shortname = 'lujun9972';
         /* * * DON'T EDIT BELOW THIS LINE * * */
         (function() {
             var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
             dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
             (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
             $('#disqus_thread').css('display','none');
         })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    <script>
     /* comments */
     var ego_disqus_thread=$('#disqus_thread');
     var ego_ds_label=$('.ds-thread');
     $('.disqus_label').click(function(){
         ego_disqus_thread.show();
         ego_ds_label.hide();
     });
     $('.ds-label').click(function(){
         ego_disqus_thread.hide();
         ego_ds_label.show();
     });
    </script>
        </section>
    <script src="https://lujun9972.github.io/media/js/main.js"></script>
    <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 25.x(<a href="http://orgmode.org">Org mode</a> 9.x)</p>
        <p>
            Copyright &copy; 2014 - <span id="footerYear"></span> <a href="mailto:lujun9972 &lt;at&gt; F31">DarkSun</a>
            &nbsp;&nbsp;-&nbsp;&nbsp;
            Powered by <a href="https://github.com/emacs-china/ego" target="_blank">EGO</a><br/>
            <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" style="border-width:0" alt="Creative Commons License" class="center"></a>
            <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
    </div>
            </div>
            <script type="text/javascript"
                    src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_SVG">
            </script>
            <script type="text/x-mathjax-config">
             MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "AMS"} } });
            </script>
</div>

  </div></body>
</html>
